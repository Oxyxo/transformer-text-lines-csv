<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CAT file reader</title>
</head>
<body>
  <div>
    <p>Select a CAT file to process</p>

    <input type="file" id="file" />
    <input type="button" value="submit" id="submit" />
  </div>

  <script type="application/javascript">
    var file = document.getElementById("file");
    var submit = document.getElementById("submit");
    
    submit.addEventListener("click", handle);

    // handle is the controller responsible for the
    // reading and processing of the given file and settings
    function handle() {
      var document = file.files[0];
      var line = "";
      
      loader(document, function (data) {
        for (var i = 0; i < data.byteLength; i++) {
          console.log(String.fromCharCode(new Uint8Array(data.slice(i, i+1))[0]))
        }
      }, function() {
        console.log("done!!")
      })
    }

    // Hashing big files with JavaScript
    // https://medium.com/@0xVaccaro/hashing-big-file-with-filereader-js-e0a5c898fc98

    // loader set's up a new FileReader that reads the given file in chunks
    function loader(file, callbackProgress, callbackFinal) {
      var chunkSize = 1024 * 1024 // Bytes - ~1.04MB
      var offset = 0;
      var size = chunkSize;
      var partial;
      var index = 0;

      if (file.size === 0) {
        callbackFinal();
      }
      while (offset < file.size) {
        partial = file.slice(offset, offset + size);
        var reader = new FileReader;
        reader.size = chunkSize;
        reader.offset = offset;
        reader.index = index;
        reader.onload = function (evt) {
          callbackRead(this, file, evt, callbackProgress, callbackFinal);
        };
        reader.readAsArrayBuffer(partial);
        offset += chunkSize;
        index += 1;
      }
    }

    var previous = [];
    var lastOffset = 0;

    // callbackRead checks the given result and returns it to the callbackProgress
    function callbackRead(reader, file, evt, callbackProgress, callbackFinal) {
      if (lastOffset !== reader.offset) {
        // not of order chunk: put into buffer
        previous.push({ offset: reader.offset, size: reader.size, result: reader.result });
        return;
      }

      function parseResult(offset, size, result) {
        lastOffset = offset + size;
        callbackProgress(result);
        if (offset + size >= file.size) {
          lastOffset = 0;
          callbackFinal();
        }
      }

      // in order chunk
      parseResult(reader.offset, reader.size, reader.result);

      // check previous buffered chunks
      var buffered = [{}]
      while (buffered.length > 0) {
        buffered = previous.filter(function (item) {
          return item.offset === lastOffset;
        });
        buffered.forEach(function (item) {
          parseResult(item.offset, item.size, item.result);
          previous.remove(item);
        })
      }
    }
  </script>
</body>
</html>
